rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * CORE PHILOSOPHY
     * This ruleset enforces a robust authorization model for Salon Chair, prioritising 
     * Authorization Independence through denormalization. By storing owner and user 
     * IDs directly on documents, we ensure fast, performant, and secure access control 
     * without deep document lookups.
     */

    // --- GLOBAL HELPER FUNCTIONS ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      // Check for existence in the admins collection. 
      // Note: We avoid calling isAdmin() inside the admins collection rule to prevent recursion.
      return isSignedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // Validates that the user is using a verified Gmail account
    function isVerifiedGmail() {
      return isSignedIn() && 
             request.auth.token.email_verified == true && 
             request.auth.token.email.matches('.*@gmail\\.com$');
    }

    // --- COLLECTION RULES ---

    /**
     * @description Rules for user profiles.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isAdmin();
    }

    /**
     * @description Restricted collection for global administrators.
     */
    match /admins/{adminId} {
      // Anyone signed in can attempt to get their own admin doc to check status
      allow get: if isSignedIn() && request.auth.uid == adminId;
      allow list, create, update, delete: if false;
    }

    /**
     * @description Salons are publicly readable for discovery.
     */
    match /salons/{salonId} {
      allow get, list: if true;
      allow create: if isVerifiedGmail() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isAdmin() || (isSignedIn() && resource.data.ownerId == request.auth.uid);
      allow delete: if isAdmin() || (isSignedIn() && resource.data.ownerId == request.auth.uid);

      /**
       * @description Services nested under salons.
       */
      match /services/{serviceId} {
        allow get, list: if true;
        allow create, update, delete: if isAdmin() || (isSignedIn() && get(/databases/$(database)/documents/salons/$(salonId)).data.ownerId == request.auth.uid);
      }

      /**
       * @description Subscription details for a salon.
       */
      match /subscriptions/{subscriptionId} {
        allow get, list: if isAdmin() || (isSignedIn() && get(/databases/$(database)/documents/salons/$(salonId)).data.ownerId == request.auth.uid);
        allow create, update: if isAdmin() || (isVerifiedGmail() && get(/databases/$(database)/documents/salons/$(salonId)).data.ownerId == request.auth.uid);
        allow delete: if isAdmin();

        /**
         * @description Payment transactions.
         */
        match /payments/{paymentId} {
          allow get, list: if isAdmin() || (isSignedIn() && get(/databases/$(database)/documents/salons/$(salonId)).data.ownerId == request.auth.uid);
          allow create, update, delete: if isAdmin();
        }
      }
    }

    /**
     * @description Bookings accessible by the customer (userId) or the provider (salonOwnerId).
     * Enforcing resource.data checks on 'read' (get/list) ensures users can only query their own bookings.
     */
    match /bookings/{bookingId} {
      allow read: if isSignedIn() && (
        isAdmin() || 
        request.auth.uid == resource.data.userId || 
        request.auth.uid == resource.data.salonOwnerId
      );
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && (
        isAdmin() || 
        request.auth.uid == resource.data.userId || 
        request.auth.uid == resource.data.salonOwnerId
      );
      allow delete: if isAdmin();
    }

    /**
     * @description No-show flags recorded by owners against users.
     */
    match /noShowFlags/{noShowFlagId} {
      allow get: if isAdmin() || isOwner(resource.data.flaggedUserId) || isOwner(resource.data.flaggedBySalonOwnerId);
      allow list: if isAdmin() || isSignedIn(); // Typically filtered by owner or user
      allow create: if isVerifiedGmail() && request.resource.data.flaggedBySalonOwnerId == request.auth.uid;
      allow update, delete: if isAdmin();
    }
  }
}